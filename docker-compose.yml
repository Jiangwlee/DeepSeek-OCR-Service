services:
  traefik:
    image: traefik:latest
    container_name: traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"   # Dashboard 可选
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - ocr_net

  mineru-api:
    image: mineru:latest
    container_name: mineru-api
    restart: always
    environment:
      MINERU_MODEL_SOURCE: local
    entrypoint: mineru-api
    command:
      # ==================== Server Configuration ====================
      - --host
      - 0.0.0.0
      - --port
      - "8000"

      # ==================== vLLM Engine Parameters ====================
      # Multi-GPU configuration
      # - --data-parallel-size
      # - "2"
      # Single GPU memory optimization
      # - --gpu-memory-utilization
      # - "0.5"  # Try 0.4 or lower if VRAM insufficient

      # ==================== LMDeploy Engine Parameters ====================
      # Multi-GPU configuration
      # - --dp
      # - "2"
      # Single GPU memory optimization
      # - --cache-max-entry-count
      # - "0.5"  # Try 0.4 or lower if VRAM insufficient
    ulimits:
      memlock: -1
      stack: 67108864
    ipc: host
    networks:
      - ocr_net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["0"]  # Modify for multiple GPUs: ["0", "1"]
              capabilities: [gpu]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mineru.rule=PathPrefix(`/mineru`)"
      - "traefik.http.routers.mineru.middlewares=mineru-stripprefix"
      - "traefik.http.middlewares.mineru-stripprefix.stripprefix.prefixes=/mineru"
      - "traefik.http.services.mineru.loadbalancer.server.port=8000"


networks:
  ocr_net:
    external: true
